{% extends '@DFPEtapI/layout.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
        <link href="{{ asset('css/lista_klientow.css') }}" rel="stylesheet" />
{% endblock stylesheets %}

{% block javascript %}
    {{ parent() }}
    {% javascripts '@DFPEtapIBundle/Resources/public/js/*' %}
        <script type="text/javascript" src="{{ asset_url }}"></script>
    {% endjavascripts %}
{% endblock javascript %}

{% block content -%}
    <section>
        <h1>Lista klientów</h1>

        <div style="margin-bottom: 20px; height: auto; overflow: auto;">
            {{ knp_pagination_filter(filie_uzytkownika, {'k.nazwaSkrocona': 'Nazwa klienta', 'f.miejscowosc': 'Miejscowość', 'k.kodMax': 'Kod MAX', 'pd.nazwaProfilu':'Profil działalności'}) }}
        </div>


        <table class="lista-klientow">
            <thead>
            <tr>
                <th colspan="6"></th>
                <th colspan="2">Ostrzeżenia</th>
            </tr>
            <tr>
                <th class="lp">Lp</th>
                <th class="klient-nazwa-skrocona {% if filie_uzytkownika.isSorted('k.nazwaSkrocona') %} sorted {% endif %}">{{ knp_pagination_sortable(filie_uzytkownika, 'Klient', 'k.nazwaSkrocona') }}</th>
                <th class="filia-nazwa">Nazwa filii</th>
                <th class="filia-miejscowosc {% if filie_uzytkownika.isSorted('f.miejscowosc') %} sorted {% endif %}">{{ knp_pagination_sortable(filie_uzytkownika, 'Miejscowość', 'f.miejscowosc') }}</th>
                <th class="kod-max">Kod MAX</th>
                <th class="klient-profil-dzialalnosci">{{ knp_pagination_sortable(filie_uzytkownika, 'Profil działalności', 'pd.nazwaProfilu') }}</th>
                <th>Obrót</th>
                <th>Notatka</th>
            </tr>
            </thead>
            <tbody>
            {% for filia_uzytkownika in filie_uzytkownika %}
                {% if filia_uzytkownika.koniecPrzypisania < date() and filia_uzytkownika.perm == false %}
                    {% set blokada = filia_uzytkownika.blokada %}
                    {% set blokada_o = filia_uzytkownika.filia.klient.obrot > 3000 ? false : true %}
                    {% set blokada_n = true %}
                    {% set dataOstatniejNotatki = '-' %}
                    {% set dataTemp = '' %}
                    {% for notatka in filia_uzytkownika.filia.filieNotatki %}
                        {% if notatka.dataSporzadzenia|date_modify('+30days') > date() %}
                            {% set blokada_n = false %}
                        {% endif %}
                        {% set dataOstatniejNotatki = dataTemp < dataOstatniejNotatki ? notatka.dataSporzadzenia|date('d.m.Y') : dataOstatniejNotatki|date('d.m.Y') %}
                        {% set dataTemp = notatka.dataSporzadzenia %}
                    {% endfor %}
                    <tr {{ blokada == true or (blokada_n == true and blokada_o == true ) ? "class='przeterminowane'" : "" }}>
                        <th class="lp"><a href="{{ path('frontend_pokaz_filie_klienta', { 'id': filia_uzytkownika.filia.id }) }}">{{ loop.index }}</a></th>
                        <td class="klient-nazwa-skrocona" title="Pełna nazwa: {{ filia_uzytkownika.filia.klient.nazwaPelna }}"><div>{{ filia_uzytkownika.filia.klient.nazwaSkrocona > 70 ? filia_uzytkownika.filia.klient.nazwaSkrocona[:70] ~ " ..." : filia_uzytkownika.filia.klient.nazwaSkrocona }}</div></td>
                        <td class="filia-nazwa">{{ filia_uzytkownika.filia.nazwaFilii }}</td>
                        <td class="filia-miejscowosc" title="{{ filia_uzytkownika.filia.ulica }}&#10;{{ filia_uzytkownika.filia.kodPocztowy|kodPocztowy }}; {{ filia_uzytkownika.filia.miejscowosc }}&#10;{{ filia_uzytkownika.filia.wojewodztwo }}">{{ filia_uzytkownika.filia.miejscowosc }}</td>
                        <td class="kod-max">{{ filia_uzytkownika.filia.klient.kodMax }}</td>
                        <td class="klient-profil-dzialalnosci"><div title="{{ filia_uzytkownika.filia.profileDzialalnosci|join(' | ') }}">{{ filia_uzytkownika.filia.profileDzialalnosci|join(' | ') }}</div></td>
                        <td style="text-align: right; color: {{ blokada_o == true ? 'red' }}; ">
                            {{ filia_uzytkownika.filia.klient.obrot|number_format(2,',',' ') }} zł
                        </td>
                        <td style="color: {{ blokada_n == true ? 'red' }};">
                            {{ dataOstatniejNotatki is defined ? dataOstatniejNotatki }}
                        </td>
                    </tr>
                {% else %}
                    {% set blokada = filia_uzytkownika.blokada %}
                    {% set blokada_o = filia_uzytkownika.filia.klient.obrot > 3000 ? false : true %}
                    {% set blokada_n = true %}
                    {% set dataOstatniejNotatki = '-' %}
                    {% set dataTemp = '' %}
                    {% for notatka in filia_uzytkownika.filia.filieNotatki %}
                        {% if notatka.dataSporzadzenia|date_modify('+30days') > date() %}
                            {% set blokada_n = false %}
                        {% endif %}
                        {% set dataOstatniejNotatki = dataTemp < dataOstatniejNotatki ? notatka.dataSporzadzenia|date('d.m.Y') : dataOstatniejNotatki|date('d.m.Y') %}
                        {% set dataTemp = notatka.dataSporzadzenia %}
                    {% endfor %}
                    <tr>
                        <th class="lp"><a href="{{ path('frontend_pokaz_filie_klienta', { 'id': filia_uzytkownika.filia.id }) }}">{{ loop.index }}</a></th>
                        <td class="klient-nazwa-skrocona" title="Pełna nazwa: {{ filia_uzytkownika.filia.klient.nazwaPelna }}"><div>{{ filia_uzytkownika.filia.klient.nazwaSkrocona > 70 ? filia_uzytkownika.filia.klient.nazwaSkrocona[:70] ~ " ..." : filia_uzytkownika.filia.klient.nazwaSkrocona }}</div></td>
                        <td class="filia-nazwa">{{ filia_uzytkownika.filia.nazwaFilii }}</td>
                        <td class="filia-miejscowosc" title="{{ filia_uzytkownika.filia.ulica }}&#10;{{ filia_uzytkownika.filia.kodPocztowy|kodPocztowy }}; {{ filia_uzytkownika.filia.miejscowosc }}&#10;{{ filia_uzytkownika.filia.wojewodztwo }}">{{ filia_uzytkownika.filia.miejscowosc }}</td>
                        <td class="kod-max">{{ filia_uzytkownika.filia.klient.kodMax }}</td>
                        <td class="klient-profil-dzialalnosci"><div title="{{ filia_uzytkownika.filia.profileDzialalnosci|join(' | ') }}">{{ filia_uzytkownika.filia.profileDzialalnosci|join(' | ') }}</div></td>
                        <td style="text-align: right; color: {{ blokada_o == true ? 'red' }}; ">
                            {{ filia_uzytkownika.filia.klient.obrot|number_format(2,',',' ') }} zł
                        </td>
                        <td style="color: {{ blokada_n == true ? 'red' }};">
                            {{ dataOstatniejNotatki is defined ? dataOstatniejNotatki }}
                        </td>
                    </tr>
                {% endif %}
            {% endfor %}
            </tbody>
        </table>

        <div class="navigation">
            {{ knp_pagination_render(filie_uzytkownika) }}
        </div>
    </section>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
        $('.lista-klientow').obslugaTabel();
{% endblock javascripts %}
